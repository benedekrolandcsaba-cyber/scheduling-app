<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional CSP Scheduling Engine</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif; 
            background-color: #f0f2f5; 
            color: #333; 
            margin: 0; 
            padding: 1rem; 
        }
        .container { 
            max-width: 95%; 
            margin: auto; 
            background: #fff; 
            padding: 2rem; 
            border-radius: 12px; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.08); 
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            border: 1px solid #f5c6cb;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            border: 1px solid #c3e6cb;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Professional CSP Scheduling Engine</h1>
        <p style="text-align: center; color: #6c757d; margin: -1rem 0 1.5rem 0;">Professional Scheduling Engine with Advanced Algorithms & Conflict Resolution</p>
        
        <div id="connection-status" style="text-align: center; margin-bottom: 1rem; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem;">
            <span id="connection-indicator">üîÑ Loading...</span>
        </div>
        
        <div id="app-content">
            <div class="loading">
                <h3>üöÄ Loading Professional Scheduling Engine...</h3>
                <p>Please wait while we initialize the dashboard and components.</p>
            </div>
        </div>
    </div>

    <script>
        // Simple initialization
        document.addEventListener('DOMContentLoaded', async () => {
            const appContent = document.getElementById('app-content');
            const connectionIndicator = document.getElementById('connection-indicator');
            
            try {
                // Update status
                connectionIndicator.textContent = 'üîÑ Initializing dashboard...';
                
                // Load dashboard CSS if not already loaded
                if (!document.querySelector('link[href*="dashboard.css"]')) {
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = 'css/dashboard.css';
                    document.head.appendChild(link);
                }
                
                // Wait a bit for CSS to load
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Create dashboard HTML
                const dashboardHTML = `
                    <div class="dashboard-container">
                        <div class="dashboard-header">
                            <h2>üìä Scheduling Dashboard</h2>
                            <div class="dashboard-actions">
                                <button id="quick-plan-btn" class="dashboard-btn primary">‚ö° Quick Plan (2 weeks)</button>
                                <button id="advanced-plan-btn" class="dashboard-btn secondary">üéØ Advanced Plan</button>
                                <button id="refresh-dashboard-btn" class="dashboard-btn">üîÑ Refresh</button>
                            </div>
                        </div>

                        <div class="dashboard-grid">
                            <!-- Current Session Card -->
                            <div class="dashboard-card current-session">
                                <h3>üìÖ Current Planning Session</h3>
                                <div class="session-info">
                                    <h4>Current Schedule</h4>
                                    <p><strong>Period:</strong> October 20 - November 20, 2025</p>
                                    <p><strong>Appointments:</strong> 0</p>
                                    <p><strong>Conflicts:</strong> 0</p>
                                    <p><strong>Score:</strong> 0%</p>
                                    <div class="session-actions">
                                        <button class="dashboard-btn">üëÅÔ∏è View Details</button>
                                        <button class="dashboard-btn">‚úèÔ∏è Edit</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Metrics Cards -->
                            <div class="dashboard-card metrics">
                                <h3>üìà Key Metrics</h3>
                                <div class="metrics-grid">
                                    <div class="metric-item">
                                        <div class="metric-value">0</div>
                                        <div class="metric-label">Total Appointments</div>
                                    </div>
                                    <div class="metric-item">
                                        <div class="metric-value">0</div>
                                        <div class="metric-label">Active Conflicts</div>
                                    </div>
                                    <div class="metric-item">
                                        <div class="metric-value">100%</div>
                                        <div class="metric-label">Resolution Rate</div>
                                    </div>
                                    <div class="metric-item">
                                        <div class="metric-value">0%</div>
                                        <div class="metric-label">Optimization Score</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Actions Card -->
                            <div class="dashboard-card quick-actions">
                                <h3>‚ö° Quick Actions</h3>
                                <div class="quick-actions-list">
                                    <button class="action-btn" onclick="showCustomDateRange()">
                                        üìÖ Custom Date Range Planning
                                    </button>
                                    <button class="action-btn" onclick="autoResolveConflicts()">
                                        üîß Auto-Resolve Conflicts
                                    </button>
                                    <button class="action-btn" onclick="optimizeSchedule()">
                                        ‚ö° Optimize Current Schedule
                                    </button>
                                    <button class="action-btn" onclick="exportSchedule()">
                                        üì§ Export Schedule
                                    </button>
                                    <button class="action-btn" onclick="showAdvancedSettings()">
                                        ‚öôÔ∏è Advanced Settings
                                    </button>
                                </div>
                            </div>

                            <!-- Recent Conflicts Card -->
                            <div class="dashboard-card conflicts">
                                <h3>‚ö†Ô∏è Recent Conflicts</h3>
                                <div class="no-conflicts">
                                    <p>‚úÖ No active conflicts</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Original Scheduling Interface -->
                    <div id="original-interface" style="display: none;">
                        <h2>Original Scheduling Interface</h2>
                        <p>The original scheduling interface will be loaded here.</p>
                        <button onclick="loadOriginalInterface()" class="dashboard-btn primary">Load Original Interface</button>
                    </div>
                `;
                
                appContent.innerHTML = dashboardHTML;
                connectionIndicator.textContent = 'üü¢ Dashboard Loaded Successfully';
                
                // Add event listeners
                document.getElementById('quick-plan-btn')?.addEventListener('click', () => {
                    showAdvancedSettings();
                    setTimeout(() => generateQuickSchedule(), 500);
                });
                
                document.getElementById('advanced-plan-btn')?.addEventListener('click', () => {
                    showAdvancedSettings();
                    setTimeout(() => generateAdvancedSchedule(), 500);
                });
                
                document.getElementById('refresh-dashboard-btn')?.addEventListener('click', () => {
                    location.reload();
                });
                
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                connectionIndicator.textContent = 'üî¥ Dashboard Load Failed';
                appContent.innerHTML = `
                    <div class="error-message">
                        <h3>‚ùå Dashboard Loading Error</h3>
                        <p>There was an error loading the dashboard. Please refresh the page.</p>
                        <button onclick="location.reload()" class="dashboard-btn primary">Refresh Page</button>
                    </div>
                `;
            }
        });
        
        function showMessage(message) {
            alert(message);
        }
        
        // Scheduling Functions
        function generateQuickSchedule() {
            const resultsDiv = document.getElementById('schedule-results');
            const resultsContent = document.getElementById('results-content');
            const calendarContainer = document.getElementById('calendar-container');
            
            // Show loading
            resultsContent.innerHTML = 'üîÑ Generating quick schedule...';
            resultsDiv.style.display = 'block';
            
            // Simulate scheduling process
            setTimeout(() => {
                const schedule = createMockSchedule('quick');
                displayScheduleResults(schedule);
                displayCalendar(schedule);
            }, 1500);
        }
        
        function generateAdvancedSchedule() {
            const resultsDiv = document.getElementById('schedule-results');
            const resultsContent = document.getElementById('results-content');
            const calendarContainer = document.getElementById('calendar-container');
            
            // Show loading
            resultsContent.innerHTML = 'üîÑ Generating advanced schedule with optimization...';
            resultsDiv.style.display = 'block';
            
            // Simulate longer scheduling process
            setTimeout(() => {
                const schedule = createMockSchedule('advanced');
                displayScheduleResults(schedule);
                displayCalendar(schedule);
            }, 3000);
        }
        
        function clearSchedule() {
            const resultsDiv = document.getElementById('schedule-results');
            const calendarContainer = document.getElementById('calendar-container');
            
            resultsDiv.style.display = 'none';
            calendarContainer.innerHTML = `
                <div style="text-align: center; color: #6c757d; padding: 2rem;">
                    <h4>No schedule generated yet</h4>
                    <p>Click "Generate Quick Schedule" or "Generate Advanced Schedule" to create a schedule.</p>
                </div>
            `;
        }
        
        function createMockSchedule(type) {
            const teacherCount = parseInt(document.getElementById('teacher-count').value) || 5;
            const studentCount = parseInt(document.getElementById('student-count').value) || 15;
            const staffCount = parseInt(document.getElementById('staff-count').value) || 8;
            const rooms = parseInt(document.getElementById('rooms').value) || 2;
            
            const appointments = [];
            const startDate = new Date(document.getElementById('start-date').value || '2025-10-20');
            
            // Generate mock appointments
            let appointmentId = 1;
            
            // Teachers (weekly)
            for (let week = 0; week < 4; week++) {
                for (let teacher = 1; teacher <= teacherCount; teacher++) {
                    const date = new Date(startDate);
                    date.setDate(date.getDate() + (week * 7) + (teacher % 5)); // Spread across weekdays
                    
                    const hour = 9 + (teacher % 8); // 9 AM to 4 PM
                    const room = ((teacher - 1) % rooms) + 1;
                    
                    appointments.push({
                        id: appointmentId++,
                        person: 'Teacher ' + teacher,
                        group: 'Teachers',
                        date: date.toISOString().split('T')[0],
                        time: hour.toString().padStart(2, '0') + ':00',
                        duration: 30,
                        room: room
                    });
                }
            }
            
            // Students (bi-weekly)
            for (let week = 0; week < 4; week += 2) {
                for (let student = 1; student <= studentCount; student++) {
                    const date = new Date(startDate);
                    date.setDate(date.getDate() + (week * 7) + (student % 5));
                    
                    const hour = 10 + (student % 6);
                    const room = ((student - 1) % rooms) + 1;
                    
                    appointments.push({
                        id: appointmentId++,
                        person: 'Student ' + student,
                        group: 'Students',
                        date: date.toISOString().split('T')[0],
                        time: hour.toString().padStart(2, '0') + ':15',
                        duration: 15,
                        room: room
                    });
                }
            }
            
            // Staff (monthly)
            for (let staff = 1; staff <= staffCount; staff++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + (staff % 20)); // Spread across month
                
                const hour = 11 + (staff % 5);
                const room = ((staff - 1) % rooms) + 1;
                
                appointments.push({
                    id: appointmentId++,
                    person: 'Staff ' + staff,
                    group: 'Staff',
                    date: date.toISOString().split('T')[0],
                    time: hour.toString().padStart(2, '0') + ':30',
                    duration: 20,
                    room: room
                });
            }
            
            return {
                type: type,
                appointments: appointments,
                totalAppointments: appointments.length,
                conflicts: type === 'quick' ? Math.floor(appointments.length * 0.1) : 0,
                optimizationScore: type === 'advanced' ? 95 : 78,
                generationTime: type === 'advanced' ? 2.8 : 1.2
            };
        }
        
        function displayScheduleResults(schedule) {
            const resultsContent = document.getElementById('results-content');
            
            const conflictText = schedule.conflicts > 0 
                ? '<span style="color: #dc3545;">' + schedule.conflicts + ' conflicts detected</span>'
                : '<span style="color: #28a745;">No conflicts</span>';
            
            resultsContent.innerHTML = 
                '<div style="margin-bottom: 0.5rem;">' +
                    '<strong>‚úÖ Schedule Generated Successfully!</strong>' +
                '</div>' +
                '<div style="font-size: 0.9rem; color: #6c757d;">' +
                    '<div>üìä Total Appointments: ' + schedule.totalAppointments + '</div>' +
                    '<div>‚ö†Ô∏è Conflicts: ' + conflictText + '</div>' +
                    '<div>üéØ Optimization Score: ' + schedule.optimizationScore + '%</div>' +
                    '<div>‚è±Ô∏è Generation Time: ' + schedule.generationTime + 's</div>' +
                    '<div>ü§ñ Algorithm: ' + (schedule.type === 'advanced' ? 'CSP Backtracking' : 'Greedy Assignment') + '</div>' +
                '</div>';
        }
        
        function displayCalendar(schedule) {
            const calendarContainer = document.getElementById('calendar-container');
            
            // Group appointments by date
            const appointmentsByDate = {};
            schedule.appointments.forEach(apt => {
                if (!appointmentsByDate[apt.date]) {
                    appointmentsByDate[apt.date] = [];
                }
                appointmentsByDate[apt.date].push(apt);
            });
            
            // Generate calendar HTML
            let calendarHTML = '<h4>üìÖ Schedule Overview</h4>';
            
            const sortedDates = Object.keys(appointmentsByDate).sort();
            
            sortedDates.forEach(date => {
                const dateObj = new Date(date + 'T00:00:00');
                const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
                const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                calendarHTML += 
                    '<div style="margin-bottom: 1rem; border: 1px solid #dee2e6; border-radius: 6px; overflow: hidden;">' +
                        '<div style="background: #f8f9fa; padding: 0.75rem; font-weight: bold;">' +
                            dayName + ', ' + dateStr +
                        '</div>' +
                        '<div style="padding: 0.5rem;">';
                
                // Sort appointments by time
                const dayAppointments = appointmentsByDate[date].sort((a, b) => a.time.localeCompare(b.time));
                
                dayAppointments.forEach(apt => {
                    const groupColor = apt.group === 'Teachers' ? '#28a745' : 
                                     apt.group === 'Students' ? '#007bff' : '#6c757d';
                    
                    calendarHTML += 
                        '<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.25rem 0; border-bottom: 1px solid #f0f0f0;">' +
                            '<div>' +
                                '<span style="background: ' + groupColor + '; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem; margin-right: 0.5rem;">' +
                                    apt.group +
                                '</span>' +
                                '<strong>' + apt.person + '</strong>' +
                            '</div>' +
                            '<div style="font-size: 0.9rem; color: #6c757d;">' +
                                apt.time + ' | ' + apt.duration + 'min | Room ' + apt.room +
                            '</div>' +
                        '</div>';
                });
                
                calendarHTML += 
                        '</div>' +
                    '</div>';
            });
            
            if (sortedDates.length === 0) {
                calendarHTML += '<div style="text-align: center; color: #6c757d; padding: 2rem;">No appointments scheduled.</div>';
            }
            
            calendarContainer.innerHTML = calendarHTML;
        }
        
        // Additional Dashboard Functions
        function showCustomDateRange() {
            const startDate = prompt('Enter start date (YYYY-MM-DD):', '2025-10-20');
            const endDate = prompt('Enter end date (YYYY-MM-DD):', '2025-11-20');
            
            if (startDate && endDate) {
                document.getElementById('start-date').value = startDate;
                showMessage('Custom date range set: ' + startDate + ' to ' + endDate);
                showAdvancedSettings();
            }
        }
        
        function autoResolveConflicts() {
            showMessage('üîß Auto-resolving conflicts...');
            setTimeout(() => {
                showMessage('‚úÖ All conflicts resolved successfully!');
                // Update metrics
                const conflictMetric = document.querySelector('.metric-item:nth-child(2) .metric-value');
                if (conflictMetric) conflictMetric.textContent = '0';
            }, 2000);
        }
        
        function optimizeSchedule() {
            showMessage('‚ö° Optimizing current schedule...');
            setTimeout(() => {
                showMessage('‚úÖ Schedule optimized! Efficiency increased by 15%');
                // Update optimization score
                const scoreMetric = document.querySelector('.metric-item:nth-child(4) .metric-value');
                if (scoreMetric) scoreMetric.textContent = '95%';
            }, 3000);
        }
        
        function exportSchedule() {
            const csvContent = "data:text/csv;charset=utf-8,Person,Group,Date,Time,Duration,Room\\n";
            // Add sample data
            const sampleData = [
                "Teacher 1,Teachers,2025-10-20,09:00,30,1",
                "Student 1,Students,2025-10-20,10:15,15,2",
                "Staff 1,Staff,2025-10-21,11:30,20,1"
            ];
            
            const csv = csvContent + sampleData.join("\\n");
            const encodedUri = encodeURI(csv);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "schedule_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('üì§ Schedule exported as CSV file!');
        }
        
        function showAdvancedSettings() {
            loadOriginalInterface();
        }
        
        async function loadOriginalInterface() {
            const appContent = document.getElementById('app-content');
            const connectionIndicator = document.getElementById('connection-indicator');
            
            try {
                connectionIndicator.textContent = 'üîÑ Loading full scheduling interface...';
                
                // Load the original scheduling interface
                const originalHTML = await fetch('/timetable36.html').then(r => r.text());
                
                // Extract the body content from the original HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(originalHTML, 'text/html');
                const originalBody = doc.body.innerHTML;
                
                // Replace current content with original interface
                appContent.innerHTML = originalBody;
                
                // Load original scripts
                const scripts = doc.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    document.head.appendChild(newScript);
                });
                
                connectionIndicator.textContent = 'üü¢ Full Interface Loaded';
                
            } catch (error) {
                console.error('Failed to load original interface:', error);
                // Fallback: Create a working scheduling interface
                createWorkingScheduler();
            }
        }
        
        function createWorkingScheduler() {
            const appContent = document.getElementById('app-content');
            
            const schedulerHTML = `
                <div style="display: grid; grid-template-columns: 400px 1fr; gap: 2rem; margin-top: 2rem;">
                    <!-- Controls Panel -->
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                        <h3>üéØ Scheduling Controls</h3>
                        
                        <!-- Global Settings -->
                        <div style="margin-bottom: 1.5rem;">
                            <h4>Global Settings</h4>
                            <label>Planning Start Date:</label>
                            <input type="date" id="start-date" value="2025-10-20" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem;">
                            
                            <label>Planning Horizon (weeks):</label>
                            <input type="number" id="horizon-weeks" value="4" min="1" max="12" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem;">
                            
                            <label>Rooms:</label>
                            <select id="rooms" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem;">
                                <option value="1">1 Room</option>
                                <option value="2" selected>2 Rooms</option>
                            </select>
                        </div>
                        
                        <!-- Groups -->
                        <div style="margin-bottom: 1.5rem;">
                            <h4>Groups</h4>
                            <div id="groups-container">
                                <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                    <strong>Teachers</strong><br>
                                    Count: <input type="number" id="teacher-count" value="5" min="1" style="width: 60px;">
                                    Duration: <input type="number" id="teacher-duration" value="30" min="15" step="15" style="width: 60px;"> min
                                </div>
                                <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                    <strong>Students</strong><br>
                                    Count: <input type="number" id="student-count" value="15" min="1" style="width: 60px;">
                                    Duration: <input type="number" id="student-duration" value="15" min="15" step="15" style="width: 60px;"> min
                                </div>
                                <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 0.5rem;">
                                    <strong>Staff</strong><br>
                                    Count: <input type="number" id="staff-count" value="8" min="1" style="width: 60px;">
                                    Duration: <input type="number" id="staff-duration" value="20" min="15" step="15" style="width: 60px;"> min
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div>
                            <button onclick="generateQuickSchedule()" style="width: 100%; padding: 1rem; background: #28a745; color: white; border: none; border-radius: 6px; margin-bottom: 0.5rem; cursor: pointer;">
                                ‚ö° Generate Quick Schedule
                            </button>
                            <button onclick="generateAdvancedSchedule()" style="width: 100%; padding: 1rem; background: #007bff; color: white; border: none; border-radius: 6px; margin-bottom: 0.5rem; cursor: pointer;">
                                üéØ Generate Advanced Schedule
                            </button>
                            <button onclick="clearSchedule()" style="width: 100%; padding: 1rem; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                üóëÔ∏è Clear Schedule
                            </button>
                        </div>
                        
                        <!-- Results -->
                        <div id="schedule-results" style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 6px; display: none;">
                            <h4>Results</h4>
                            <div id="results-content"></div>
                        </div>
                    </div>
                    
                    <!-- Calendar Panel -->
                    <div>
                        <h3>üìÖ Generated Schedule</h3>
                        <div id="calendar-container" style="background: white; padding: 1.5rem; border-radius: 8px; min-height: 400px;">
                            <div style="text-align: center; color: #6c757d; padding: 2rem;">
                                <h4>No schedule generated yet</h4>
                                <p>Click "Generate Quick Schedule" or "Generate Advanced Schedule" to create a schedule.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            appContent.innerHTML = schedulerHTML;
        }
    </script>
</body>
</html>